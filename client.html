<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveChat</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #0b0d13;
  --panel:   #111420;
  --sidebar: #0d1019;
  --hover:   rgba(255,255,255,.05);
  --active:  rgba(74,144,226,.12);
  --self:    #173352;
  --self-b:  #1e4a7e;
  --other:   #181c2a;
  --other-b: rgba(255,255,255,.08);
  --accent:  #4a90e2;
  --accent2: #7f6cf5;
  --green:   #34d283;
  --red:     #e85555;
  --border:  rgba(255,255,255,.07);
  --text:    #dde3f0;
  --sub:     #5e6880;
  --grad:    linear-gradient(135deg,#4a90e2,#7f6cf5);
  --r:16px; --rsm:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Manrope',sans-serif;font-size:14px;display:flex}
*{scrollbar-width:thin;scrollbar-color:var(--border) transparent}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* LOGIN */
#login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:800;transition:opacity .3s,transform .3s}
#login.out{opacity:0;transform:scale(.97);pointer-events:none}
.card{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:40px 36px 34px;width:min(380px,94vw);box-shadow:0 40px 80px rgba(0,0,0,.5)}
.logo{text-align:center;margin-bottom:24px}
.logo-icon{width:52px;height:52px;border-radius:14px;background:var(--grad);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;box-shadow:0 6px 20px rgba(74,144,226,.3)}
.logo h1{font-size:1.8rem;font-weight:800;letter-spacing:-.5px}
.logo p{color:var(--sub);font-size:.82rem;margin-top:3px}
.field{margin-bottom:13px}
.field label{display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);margin-bottom:5px}
.field input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:var(--rsm);padding:11px 13px;color:var(--text);font-family:'Manrope',sans-serif;font-size:.93rem;outline:none;transition:border-color .2s}
.field input:focus{border-color:var(--accent)}
.btn{width:100%;padding:12px;border:none;border-radius:var(--rsm);background:var(--grad);color:#fff;font-family:'Manrope',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;margin-top:6px;transition:opacity .2s,transform .15s;box-shadow:0 4px 16px rgba(74,144,226,.25)}
.btn:hover{opacity:.9;transform:translateY(-1px)}.btn:active{transform:translateY(0)}
.err{color:var(--red);font-size:.78rem;text-align:center;margin-top:6px;min-height:1.1em}

/* APP */
#app{display:flex;width:100%;opacity:0;transition:opacity .35s}
#app.on{opacity:1}

/* SIDEBAR */
#sb{width:240px;flex-shrink:0;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column}
.sb-head{padding:14px 14px 10px;border-bottom:1px solid var(--border)}
.sb-logo{font-size:1.1rem;font-weight:800}
.sb-logo em{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-style:normal}
.sb-me{font-size:.73rem;color:var(--sub);margin-top:3px}
.sb-me b{color:var(--text)}
.sb-label{padding:10px 14px 5px;font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--sub);display:flex;justify-content:space-between;align-items:center}
.sb-label span{color:var(--accent);cursor:pointer;font-size:.72rem}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;margin:1px 4px;border-radius:var(--rsm);cursor:pointer;transition:background .12s;color:var(--sub);font-size:.86rem;font-weight:600;position:relative;animation:slideIn .2s ease}
.nav-item:hover{background:var(--hover);color:var(--text)}
.nav-item.active{background:var(--active);color:var(--accent)}
.nav-item .lbl{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.badge{background:var(--red);color:#fff;border-radius:10px;padding:1px 6px;font-size:.63rem;font-weight:700;min-width:17px;text-align:center}
.sb-online{flex:1;overflow-y:auto;padding-bottom:8px}
.online-item{display:flex;align-items:center;gap:9px;padding:7px 10px;margin:1px 4px;border-radius:var(--rsm);cursor:pointer;transition:background .12s;animation:slideIn .2s ease}
.online-item:hover{background:var(--hover)}
.av32{width:32px;height:32px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;position:relative}
.av32::after{content:'';position:absolute;bottom:0;right:0;width:9px;height:9px;border-radius:50%;background:var(--green);border:2px solid var(--sidebar)}
.uname{font-size:.83rem;font-weight:600}
.ustatus{font-size:.68rem;color:var(--green)}
.call-icon-btn{background:none;border:none;cursor:pointer;font-size:1rem;padding:3px 5px;opacity:.5;transition:opacity .15s;border-radius:6px}
.call-icon-btn:hover{opacity:1;background:rgba(52,210,131,.12)}
.sb-foot{padding:9px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px}
.cdot{width:8px;height:8px;border-radius:50%;background:var(--sub);transition:background .3s}
.cdot.ok{background:var(--green);box-shadow:0 0 5px var(--green)}
.cdot.err{background:var(--red)}
.clbl{font-size:.74rem;color:var(--sub);flex:1}
.leave{background:none;border:none;cursor:pointer;color:var(--sub);font-size:.9rem;padding:4px;border-radius:5px;transition:color .15s}
.leave:hover{color:var(--red)}

/* CHAT */
#chat{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-head{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;display:flex;align-items:center;gap:12px}
.ch-av{width:34px;height:34px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700}
.ch-title{font-size:1rem;font-weight:700}
.ch-sub{font-size:.72rem;color:var(--sub);margin-top:1px}
#dm-banner{display:none;padding:8px 20px;background:rgba(127,108,245,.08);border-bottom:1px solid rgba(127,108,245,.15);align-items:center;justify-content:space-between;flex-shrink:0}
#dm-banner.show{display:flex}
#dm-banner span{font-size:.8rem;color:var(--accent2);font-weight:600}
#dm-banner button{background:none;border:none;cursor:pointer;color:var(--sub);font-size:.8rem}
#messages{flex:1;overflow-y:auto;padding:14px 18px;display:flex;flex-direction:column;gap:3px}
.date-div{display:flex;align-items:center;gap:10px;color:var(--sub);font-size:.67rem;font-weight:700;margin:8px 0;text-transform:uppercase;letter-spacing:.06em}
.date-div::before,.date-div::after{content:'';flex:1;height:1px;background:var(--border)}
.msg{display:flex;flex-direction:column;max-width:68%;animation:fadeUp .18s ease}
.msg.self{align-self:flex-end;align-items:flex-end}
.msg.other{align-self:flex-start;align-items:flex-start}
.msg.sys{align-self:center;align-items:center;max-width:100%}
.msg-meta{display:flex;align-items:center;gap:6px;margin-bottom:3px;padding:0 3px}
.sname{font-size:.72rem;font-weight:700}
.dm-pill{font-size:.62rem;padding:1px 8px;border-radius:10px;background:rgba(127,108,245,.12);border:1px solid rgba(127,108,245,.25);color:var(--accent2);margin-bottom:3px}
.bubble{padding:8px 12px;border-radius:var(--r);line-height:1.55;word-break:break-word;font-size:.88rem}
.msg.self .bubble{background:var(--self);border:1px solid var(--self-b);border-bottom-right-radius:4px}
.msg.other .bubble{background:var(--other);border:1px solid var(--other-b);border-bottom-left-radius:4px}
.msg.sys .bubble{background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--sub);font-size:.75rem;border-radius:20px;padding:4px 14px}
.btime{font-size:.63rem;color:var(--sub);margin-top:2px;padding:0 3px}
.img-msg{max-width:260px;max-height:190px;border-radius:var(--rsm);display:block;object-fit:cover;cursor:zoom-in;border:1px solid var(--border)}
.fcard{display:flex;align-items:center;gap:10px;padding:9px 13px;border-radius:var(--r);border:1px solid var(--other-b);background:var(--other);cursor:pointer;transition:filter .15s;min-width:200px}
.msg.self .fcard{background:var(--self);border-color:var(--self-b)}
.fcard:hover{filter:brightness(1.15)}
.ficon{width:36px;height:36px;border-radius:10px;background:rgba(74,144,226,.1);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.fname{font-size:.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:155px}
.fsize{font-size:.68rem;color:var(--sub);margin-top:1px}
.vmsg{display:flex;align-items:center;gap:10px;padding:9px 13px;border-radius:var(--r);background:var(--other);border:1px solid var(--other-b);min-width:210px}
.msg.self .vmsg{background:var(--self);border-color:var(--self-b)}
.vplay{width:32px;height:32px;border-radius:50%;background:var(--grad);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.85rem;flex-shrink:0;transition:transform .15s}
.vplay:hover{transform:scale(1.1)}
.vwrap{flex:1}
.vbar{width:100%;height:3px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;margin-bottom:4px}
.vfill{height:100%;background:var(--accent);border-radius:2px;width:0;transition:width .1s}
.vdur{font-size:.68rem;color:var(--sub)}
.typing-bar{height:18px;padding:0 20px;flex-shrink:0;font-size:.71rem;color:var(--sub);display:flex;align-items:center;gap:5px}
.tdots span{animation:blink 1.2s infinite;opacity:0}
.tdots span:nth-child(2){animation-delay:.2s}.tdots span:nth-child(3){animation-delay:.4s}
@keyframes blink{40%{opacity:1}80%{opacity:0}}

/* INPUT */
#ibar{padding:10px 14px;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0}
#picker{position:absolute;bottom:100%;left:0;right:0;margin-bottom:4px;background:var(--panel);border:1px solid var(--border);border-radius:var(--r);max-height:220px;overflow-y:auto;display:none;z-index:50;box-shadow:0 -12px 32px rgba(0,0,0,.4)}
#picker.open{display:block}
.pick-item{display:flex;align-items:center;gap:9px;padding:9px 14px;cursor:pointer;transition:background .12s}
.pick-item:hover{background:var(--hover)}
.pick-item .pname{font-size:.86rem;font-weight:600}
.pick-item .psub{font-size:.72rem;color:var(--sub)}
#trow{display:none;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap}
#trow.show{display:flex}
.tpill{display:flex;align-items:center;gap:5px;background:rgba(74,144,226,.1);border:1px solid rgba(74,144,226,.25);border-radius:20px;padding:3px 10px 3px 7px;font-size:.75rem;font-weight:600;color:var(--accent)}
.tpill button{background:none;border:none;cursor:pointer;color:var(--sub);font-size:.75rem;margin-left:2px}
.tpill button:hover{color:var(--red)}
#trow-label{font-size:.72rem;color:var(--sub)}
#trow-clear{font-size:.72rem;color:var(--sub);cursor:pointer;margin-left:auto}
#trow-clear:hover{color:var(--text)}
.irow{display:flex;align-items:flex-end;gap:7px;position:relative}
#inp{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:20px;padding:10px 16px;color:var(--text);font-family:'Manrope',sans-serif;font-size:.9rem;outline:none;resize:none;max-height:140px;overflow-y:auto;line-height:1.45;transition:border-color .2s}
#inp:focus{border-color:var(--accent)}
#inp::placeholder{color:var(--sub)}
.ibtn{width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;transition:opacity .2s,transform .15s}
.ibtn:hover{opacity:.85;transform:scale(1.07)}.ibtn:active{transform:scale(.93)}
#btn-file{background:rgba(255,255,255,.07);color:var(--text)}
#btn-voice{background:rgba(255,255,255,.07);color:var(--text)}
#btn-voice.rec{background:var(--red);color:#fff;animation:rpulse .8s infinite alternate}
#btn-send{background:var(--grad);color:#fff}
@keyframes rpulse{from{box-shadow:0 0 0 0 rgba(232,85,85,.4)}to{box-shadow:0 0 0 8px rgba(232,85,85,0)}}
#file-in{display:none}
#rtimer{font-size:.79rem;color:var(--red);font-family:monospace;display:none;align-items:center;gap:5px}
#rtimer.show{display:flex}
.rdot{width:7px;height:7px;border-radius:50%;background:var(--red);animation:rpulse .8s infinite alternate}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:600;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .22s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px;width:min(340px,92vw);box-shadow:0 28px 56px rgba(0,0,0,.5);transform:translateY(10px);transition:transform .22s}
.overlay.open .modal{transform:translateY(0)}
.modal h3{font-size:.95rem;font-weight:700;margin-bottom:12px}
.modal-list{display:flex;flex-direction:column;gap:3px;max-height:250px;overflow-y:auto}
.mbtn{width:100%;padding:11px;border:none;border-radius:var(--rsm);background:var(--grad);color:#fff;font-family:'Manrope',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;margin-top:12px;transition:opacity .15s}
.mbtn:hover{opacity:.88}
.mbtn.sec{background:rgba(255,255,255,.07);margin-top:6px}

/* ‚ïê‚ïê‚ïê AUDIO CALL UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#call-screen {
  display:none;position:fixed;inset:0;z-index:900;
  align-items:center;justify-content:center;
  background:rgba(11,13,19,.97);
  backdrop-filter:blur(12px);
}
#call-screen.show{display:flex}
.call-card {
  background:var(--panel);border:1px solid var(--border);
  border-radius:28px;padding:40px 48px;
  display:flex;flex-direction:column;align-items:center;gap:18px;
  box-shadow:0 48px 96px rgba(0,0,0,.6);
  min-width:280px;
}
.call-av {
  width:88px;height:88px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:2rem;font-weight:800;
  position:relative;
}
.call-av.ringing {
  animation:ring 1.2s ease-in-out infinite;
}
@keyframes ring {
  0%,100%{box-shadow:0 0 0 0 rgba(74,144,226,.5),0 0 0 0 rgba(74,144,226,.3)}
  50%{box-shadow:0 0 0 16px rgba(74,144,226,0),0 0 0 32px rgba(74,144,226,0)}
}
.call-av.active-pulse {
  animation:apulse 2s ease-in-out infinite;
}
@keyframes apulse {
  0%,100%{box-shadow:0 0 0 0 rgba(52,210,131,.4)}
  50%{box-shadow:0 0 0 14px rgba(52,210,131,0)}
}
.call-name{font-size:1.35rem;font-weight:800;letter-spacing:-.3px}
.call-status{font-size:.85rem;color:var(--sub)}
.call-timer{font-size:1.1rem;font-weight:700;font-family:monospace;color:var(--green);letter-spacing:.05em;min-height:1.4em}
.call-btns{display:flex;gap:14px;margin-top:6px}
.cbtn {
  width:60px;height:60px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;transition:transform .15s,filter .15s;
}
.cbtn:hover{transform:scale(1.1);filter:brightness(1.2)}
.cbtn:active{transform:scale(.94)}
.cbtn.green{background:#22c55e}
.cbtn.red{background:var(--red)}
.cbtn.grey{background:rgba(255,255,255,.1);font-size:1.2rem}
.cbtn.grey.on{background:rgba(232,85,85,.2);border:1px solid var(--red)}

/* wave animation during active call */
.sound-wave {
  display:flex;align-items:center;gap:4px;height:28px;
}
.sound-wave span {
  width:4px;border-radius:2px;background:var(--green);
  animation:wave 1s ease-in-out infinite;
}
.sound-wave span:nth-child(1){animation-delay:0s;height:8px}
.sound-wave span:nth-child(2){animation-delay:.15s;height:16px}
.sound-wave span:nth-child(3){animation-delay:.3s;height:24px}
.sound-wave span:nth-child(4){animation-delay:.15s;height:16px}
.sound-wave span:nth-child(5){animation-delay:0s;height:8px}
@keyframes wave{0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1)}}
.sound-wave.muted span{background:var(--sub);animation:none;transform:scaleY(.4)}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ‚Äî full redesign for small screens
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:600px){

  #sb { display:none !important; }
  #app { flex-direction:column; }
  #chat { flex:1; min-height:0; padding-bottom:56px; }

  /* Bottom nav */
  #mobile-nav {
    display:flex !important;
    position:fixed; bottom:0; left:0; right:0; z-index:300;
    background:var(--panel); border-top:1px solid var(--border);
    height:56px; align-items:stretch;
  }
  .mnav-btn {
    flex:1; display:flex; flex-direction:column; align-items:center;
    justify-content:center; gap:2px;
    background:none; border:none; cursor:pointer;
    color:var(--sub); font-size:.6rem; font-weight:700;
    text-transform:uppercase; letter-spacing:.06em;
    transition:color .15s; position:relative;
    -webkit-tap-highlight-color:transparent;
  }
  .mnav-btn .micon { font-size:1.3rem; line-height:1; }
  .mnav-btn.active { color:var(--accent); }
  .mnav-btn .mbadge {
    position:absolute; top:6px; right:calc(50% - 14px);
    background:var(--red); color:#fff; border-radius:10px;
    padding:1px 5px; font-size:.58rem; font-weight:800;
    min-width:16px; text-align:center;
  }

  /* Panels */
  #mobile-chat-panel,
  #mobile-contacts-panel {
    position:fixed; inset:0; bottom:56px;
    background:var(--bg);
    transition:transform .28s cubic-bezier(.4,0,.2,1);
    display:flex; flex-direction:column; z-index:200;
  }
  #mobile-chat-panel     { transform:translateX(0); }
  #mobile-contacts-panel { transform:translateX(100%); }
  #mobile-chat-panel.hidden      { transform:translateX(-100%); }
  #mobile-contacts-panel.visible { transform:translateX(0); }

  /* Mobile header */
  .mob-head {
    display:flex !important;
    align-items:center; gap:10px;
    padding:12px 16px; flex-shrink:0;
    background:var(--panel); border-bottom:1px solid var(--border);
  }
  .mob-head .mh-av {
    width:36px; height:36px; border-radius:50%; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    font-size:.78rem; font-weight:700;
  }
  .mob-head .mh-info { flex:1; min-width:0; }
  .mob-head .mh-title { font-size:1rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .mob-head .mh-sub   { font-size:.7rem; color:var(--sub); }
  .mob-head .mh-call  {
    background:none; border:none; cursor:pointer; font-size:1.2rem;
    padding:7px; border-radius:50%; transition:background .15s;
    -webkit-tap-highlight-color:transparent;
  }
  .mob-head .mh-call:active { background:rgba(255,255,255,.08); }

  .chat-head { display:none !important; }
  #dm-banner { display:none !important; }

  #messages { padding:10px 12px; }
  .msg { max-width:82%; }
  .bubble { font-size:.9rem; }

  #ibar {
    padding:8px 10px;
    padding-bottom:calc(8px + env(safe-area-inset-bottom));
  }
  #inp { font-size:.95rem; padding:9px 14px; }
  .ibtn { width:36px; height:36px; font-size:.95rem; }

  /* Contacts panel */
  .mob-contacts-head {
    padding:14px 16px 10px; flex-shrink:0;
    background:var(--panel); border-bottom:1px solid var(--border);
  }
  .mob-contacts-head h2 { font-size:1.1rem; font-weight:800; margin-bottom:2px; }
  .mob-contacts-head p  { font-size:.75rem; color:var(--sub); }

  .mob-section-label {
    padding:10px 16px 4px;
    font-size:.63rem; font-weight:700; text-transform:uppercase;
    letter-spacing:.12em; color:var(--sub);
  }
  .mob-contacts-scroll { flex:1; overflow-y:auto; }

  .mob-user-item {
    display:flex; align-items:center; gap:12px;
    padding:11px 16px; cursor:pointer; transition:background .12s;
    -webkit-tap-highlight-color:transparent;
  }
  .mob-user-item:active { background:var(--hover); }

  .mob-av {
    width:44px; height:44px; border-radius:50%; flex-shrink:0;
    display:flex; align-items:center; justify-content:center;
    font-size:.82rem; font-weight:800; position:relative;
  }
  .mob-av::after {
    content:''; position:absolute; bottom:1px; right:1px;
    width:11px; height:11px; border-radius:50%;
    background:var(--green); border:2px solid var(--bg);
  }
  .mob-uname   { font-size:.92rem; font-weight:700; }
  .mob-ustatus { font-size:.72rem; color:var(--green); margin-top:1px; }
  .mob-actions { display:flex; gap:6px; margin-left:auto; }
  .mob-action-btn {
    width:38px; height:38px; border-radius:50%; border:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center; font-size:1rem;
    -webkit-tap-highlight-color:transparent; transition:filter .15s;
  }
  .mob-action-btn:active { filter:brightness(1.3); }
  .mob-action-btn.chat { background:rgba(74,144,226,.15);  color:var(--accent); }
  .mob-action-btn.call { background:rgba(52,210,131,.15);  color:var(--green);  }

  .mob-dm-item {
    display:flex; align-items:center; gap:12px;
    padding:10px 16px; cursor:pointer; transition:background .12s;
    -webkit-tap-highlight-color:transparent; position:relative;
  }
  .mob-dm-item:active  { background:var(--hover); }
  .mob-dm-item.act-dm  { background:var(--active); }
  .mob-dm-badge {
    margin-left:auto;
    background:var(--red); color:#fff; border-radius:10px;
    padding:2px 7px; font-size:.65rem; font-weight:800;
  }

  .call-card { padding:32px 28px; min-width:unset; width:90vw; }
  .call-av   { width:72px; height:72px; font-size:1.6rem; }
  .call-name { font-size:1.15rem; }
  .card      { padding:32px 24px 28px; }
}

@media(min-width:601px){
  #mobile-nav,
  #mobile-chat-panel,
  #mobile-contacts-panel { display:none !important; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div class="card">
    <div class="logo">
      <div class="logo-icon">üåä</div>
      <h1>WaveChat</h1>
      <p>Open WebSocket messenger</p>
    </div>
    <div class="field"><label>Your name</label><input id="iname" placeholder="Enter your name" maxlength="32" autofocus></div>
    <p class="err" id="lerr"></p>
    <button class="btn" id="join-btn">Join ‚Üí</button>
  </div>
</div>

<!-- AUDIO CALL SCREEN -->
<div id="call-screen">
  <div class="call-card">
    <div class="call-av" id="call-av">?</div>
    <div class="call-name" id="call-name">‚Äî</div>
    <div class="call-status" id="call-status">Calling‚Ä¶</div>
    <div class="call-timer" id="call-timer"></div>
    <div class="sound-wave" id="sound-wave" style="display:none">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="call-btns" id="call-btns"></div>
  </div>
</div>
<!-- hidden audio element for remote stream -->
<audio id="remote-audio" autoplay></audio>

<!-- APP -->
<div id="app">
  <div id="sb">
    <div class="sb-head">
      <div class="sb-logo"><em>Wave</em>Chat</div>
      <div class="sb-me">Logged in as <b id="sbname">‚Äî</b></div>
    </div>
    <div class="sb-label">Direct Messages <span id="newdm-btn">+ New</span></div>
    <div id="dm-nav"></div>
    <div class="sb-label">Online ‚Äî <span id="oncount" style="color:var(--text)">0</span></div>
    <div class="sb-online" id="online-list"></div>
    <div class="sb-foot">
      <div class="cdot" id="cdot"></div>
      <span class="clbl" id="clbl">Connecting‚Ä¶</span>
      <button class="leave" id="leave-btn">‚úï</button>
    </div>
  </div>

  <div id="chat">
    <div class="chat-head">
      <div class="ch-av" id="ch-av" style="background:rgba(74,144,226,.15);color:var(--accent)">üí¨</div>
      <div>
        <div class="ch-title" id="ch-title">General Chat</div>
        <div class="ch-sub" id="ch-sub">Everyone</div>
      </div>
    </div>
    <div id="dm-banner">
      <span id="dm-banner-text">üîí Private chat</span>
      <button id="dm-back-btn">‚Üê Back to General</button>
    </div>
    <div id="messages"></div>
    <div class="typing-bar" id="typing-bar"></div>
    <div id="ibar">
      <div id="trow">
        <span id="trow-label">Send to:</span>
        <div id="tpills"></div>
        <span id="trow-clear">‚úï Everyone</span>
      </div>
      <div class="irow">
        <div id="picker"></div>
        <button class="ibtn" id="btn-file">üìé</button>
        <input type="file" id="file-in" multiple>
        <textarea id="inp" rows="1" placeholder="Message‚Ä¶ (@ to target someone)"></textarea>
        <div id="rtimer"><div class="rdot"></div><span id="rtime">0:00</span></div>
        <button class="ibtn" id="btn-voice">üé§</button>
        <button class="ibtn" id="btn-send">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê MOBILE UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Bottom navigation (mobile only) -->
<div id="mobile-nav" style="display:none">
  <button class="mnav-btn active" id="mnav-chat" onclick="mobileTab('chat')">
    <span class="micon">üí¨</span>Chat
  </button>
  <button class="mnav-btn" id="mnav-contacts" onclick="mobileTab('contacts')">
    <span class="micon">üë•</span>People
    <span class="mbadge" id="mob-badge" style="display:none">0</span>
  </button>
</div>

<!-- Mobile Chat Panel -->
<div id="mobile-chat-panel">
  <!-- Dynamic header -->
  <div class="mob-head" id="mob-chat-head">
    <div class="mh-av" id="mob-av" style="background:rgba(74,144,226,.15);color:var(--accent)">üí¨</div>
    <div class="mh-info">
      <div class="mh-title" id="mob-title">General Chat</div>
      <div class="mh-sub"   id="mob-sub">everyone</div>
    </div>
    <button class="mh-call" id="mob-call-btn" style="display:none" onclick="startCallCurrent()">üìû</button>
    <button class="mh-call" id="mob-back-btn" style="display:none" onclick="mobileBackToGeneral()">‚Üê</button>
  </div>
  <!-- Reuse #messages, #typing-bar, #ibar from #chat -->
</div>

<!-- Mobile Contacts Panel -->
<div id="mobile-contacts-panel">
  <div class="mob-contacts-head">
    <h2>üåä WaveChat</h2>
    <p id="mob-me-label">‚Äî</p>
  </div>
  <div class="mob-contacts-scroll">
    <div class="mob-section-label">Online</div>
    <div id="mob-online-list"></div>
    <div class="mob-section-label">Direct Messages</div>
    <div id="mob-dm-list"></div>
  </div>
</div>

<!-- DM modal -->
<div class="overlay" id="dm-modal">
  <div class="modal">
    <h3>üí¨ Start Direct Message</h3>
    <div class="modal-list" id="dm-modal-list"></div>
    <button class="mbtn sec" onclick="closeModal('dm-modal')">Cancel</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WS_URL = (() => {
  const p = location.protocol==='https:'?'wss:':'ws:';
  return `${p}//${location.host}/ws`;
})();
const MAX_MB = 25;
const COLORS = ['#4a90e2','#7f6cf5','#34d283','#e09535','#e04f7b','#34c4c4','#e8c53b','#a855f7'];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ws, myId, myName;
let view = 'global';
let peerName = '';
let allUsers = [];
let dmCache  = {};
let unread   = {};
let targetUser = null;
let recState, recTimer, recSec=0;
let typingTimers={};
let lastDate='',lastSender=null;
let voiceBlobs={};
let reconnTimer;
let globalCache=[];

// WebRTC / call state
const ICE = {iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]};
let pc=null, localStream=null;
let callState='idle'; // idle | outgoing | incoming | active
let callPeerId=null, callPName='';
let pendingOffer=null;
let callInterval=null, callSecs=0;
let micMuted=false;

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $=id=>document.getElementById(id);
const msgs=$('messages'), inp=$('inp');

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('join-btn').addEventListener('click',doJoin);
$('iname').addEventListener('keydown',e=>{if(e.key==='Enter')doJoin();});
function doJoin(){
  const n=$('iname').value.trim();
  if(!n){$('lerr').textContent='Enter your name';return;}
  myName=n;$('lerr').textContent='';connect();
}

// ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connect(){
  setConn('','Connecting‚Ä¶');
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{
    ws.send(J({type:'join',name:myName}));
    $('login').classList.add('out');
    $('app').classList.add('on');
    $('sbname').textContent=myName;
    setConn('ok','Connected');
    clearTimeout(reconnTimer);
  };
  ws.onmessage=e=>handle(JSON.parse(e.data));
  ws.onclose=()=>{setConn('err','Reconnecting‚Ä¶');reconnTimer=setTimeout(()=>{if(myName)connect();},3000);};
  ws.onerror=()=>setConn('err','Error');
}
function wsSend(p){ws&&ws.readyState===1&&ws.send(J(p));}
function setConn(s,l){
  $('cdot').className='cdot'+(s==='ok'?' ok':s==='err'?' err':'');
  $('clbl').textContent=l;
}

// ‚îÄ‚îÄ MESSAGE HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handle(msg){
  switch(msg.type){
    case 'init':          onInit(msg);           break;
    case 'users':         onUsers(msg);          break;
    case 'text':          onText(msg);           break;
    case 'file':          onFile(msg);           break;
    case 'voice':         onVoice(msg);          break;
    case 'system':        onSystem(msg);         break;
    case 'typing':        onTyping(msg);         break;
    case 'dm_history':    onDmHist(msg);         break;
    case 'error':         sysMsg('‚ö†Ô∏è '+msg.text);break;
    // call signaling
    case 'call-offer':    onCallOffer(msg);      break;
    case 'call-answer':   onCallAnswer(msg);     break;
    case 'ice-candidate': onIce(msg);            break;
    case 'call-reject':   onCallReject(msg);     break;
    case 'call-end':      onCallEnd(msg);        break;
    case 'call-error':    onCallError(msg);      break;
  }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onInit(msg){
  myId=msg.my_id;
  allUsers=msg.users.filter(u=>u.id!==myId);
  globalCache=[];
  msg.history.forEach(m=>{globalCache.push(m);renderMsg(m,true);});
  scrollBot(); renderOnline();
}
function onUsers(msg){
  allUsers=msg.users.filter(u=>u.id!==myId);
  $('oncount').textContent=allUsers.length;
  renderOnline(); updateHead();
}
function renderOnline(){
  const el=$('online-list');el.innerHTML='';
  allUsers.forEach(u=>{
    const d=document.createElement('div');
    d.className='online-item';
    d.innerHTML=`<div class="av32" style="background:${C(u.id)}22;color:${C(u.id)}">${ini(u.name)}</div>
      <div style="flex:1"><div class="uname">${esc(u.name)}</div><div class="ustatus">‚óè online</div></div>
      <button class="call-icon-btn" title="Call ${esc(u.name)}" onclick="event.stopPropagation();startCall(${u.id},'${esc(u.name)}')">üìû</button>`;
    d.addEventListener('click',()=>openDM(u.id,u.name));
    el.appendChild(d);
  });
  renderDmModal();
}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onText(msg){
  if(!myId&&msg.self)myId=msg.from_id;
  if(!msg.dm){globalCache.push(msg);if(globalCache.length>300)globalCache.shift();}
  routeMsg(msg,()=>renderMsg(msg));
}
function onFile(msg){
  if(!myId&&msg.self)myId=msg.from_id;
  if(!msg.dm){globalCache.push(msg);if(globalCache.length>300)globalCache.shift();}
  routeMsg(msg,()=>renderMsg(msg));
}
function onVoice(msg){
  if(!myId&&msg.self)myId=msg.from_id;
  if(!msg.dm){globalCache.push(msg);if(globalCache.length>300)globalCache.shift();}
  routeMsg(msg,()=>renderMsg(msg));
}
function routeMsg(msg,fn){
  if(msg.dm){
    const peer=msg.self?msg.to_id:msg.from_id;
    if(!dmCache[peer])dmCache[peer]=[];
    dmCache[peer].push(msg);
    if(view===peer){fn();scrollBot();}
    else if(!msg.self)incUnread('dm:'+peer);
  }else{
    if(view==='global'){fn();scrollBot();}
  }
}
function onSystem(msg){if(view==='global')sysMsg(msg.text);}
function onTyping(msg){
  if(msg.from_id===myId)return;
  const ok=msg.dm?(view===msg.from_id):(view==='global');
  if(!ok)return;
  const bar=$('typing-bar');
  bar.innerHTML=`<b>${esc(msg.from_name)}</b>&nbsp;is typing <span class="tdots"><span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span></span>`;
  clearTimeout(typingTimers[msg.from_id]);
  typingTimers[msg.from_id]=setTimeout(()=>bar.innerHTML='',3000);
}
function onDmHist(msg){
  const pid=msg.peer_id;dmCache[pid]=msg.messages;
  if(view===pid){clearMsgs();msg.messages.forEach(m=>renderMsg(m,true));scrollBot();}
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMsg(msg,historic=false){
  if(!myId&&msg.self)myId=msg.from_id;
  const isSelf=msg.self||msg.from_id===myId;
  maybeDate(msg.iso);
  const wrap=document.createElement('div');
  wrap.className=`msg ${isSelf?'self':'other'}`;
  let dmPill='';
  if(msg.dm&&isSelf)dmPill=`<div class="dm-pill">‚Üí DM to ${esc(msg.to_name||'?')}</div>`;
  if(msg.dm&&!isSelf)dmPill=`<div class="dm-pill">üîí DM</div>`;
  const showMeta=!isSelf&&lastSender!==msg.from_id;
  lastSender=msg.from_id;
  let inner='';
  if(msg.type==='text'){
    inner=`<div class="bubble">${linkify(esc(msg.text))}</div>`;
  }else if(msg.type==='file'){
    const isImg=(msg.mime||'').startsWith('image/');
    if(isImg&&msg.data){
      inner=`<img class="img-msg" src="data:${msg.mime};base64,${msg.data}" alt="${esc(msg.filename)}" loading="lazy" onclick="lightbox('${msg.mime}','${msg.data}')">`;
    }else{
      inner=`<div class="fcard" onclick="${msg.data?`dlFile('${esc(msg.filename)}','${msg.mime||''}','${msg.data}')`:''}" >
        <div class="ficon">${fEmoji(msg.mime)}</div>
        <div><div class="fname">${esc(msg.filename)}</div><div class="fsize">${fmtB(msg.size)}</div></div></div>`;
    }
  }else if(msg.type==='voice'){
    const uid='v'+Math.random().toString(36).slice(2,8);
    voiceBlobs[uid]=msg.data;
    inner=`<div class="vmsg">
      <button class="vplay" onclick="playVoice('${uid}',this)">‚ñ∂</button>
      <div class="vwrap"><div class="vbar"><div class="vfill" id="vf-${uid}"></div></div>
      <div class="vdur" id="vd-${uid}">${fmtDur(msg.duration||0)}</div></div></div>`;
  }
  wrap.innerHTML=`${dmPill}
    ${showMeta?`<div class="msg-meta"><span class="sname" style="color:${C(msg.from_id)}">${esc(msg.from_name)}</span></div>`:''}
    ${inner}<div class="btime">${msg.ts||''}</div>`;
  msgs.appendChild(wrap);
}
function sysMsg(text){
  lastSender=null;
  const w=document.createElement('div');w.className='msg sys';
  w.innerHTML=`<div class="bubble">${esc(text)}</div>`;
  msgs.appendChild(w);scrollBot();
}
function playVoice(uid,btn){
  const b64=voiceBlobs[uid];if(!b64)return;
  const blob=b64Blob(b64,'audio/webm'),url=URL.createObjectURL(blob),au=new Audio(url);
  btn.textContent='‚èπ';
  au.ontimeupdate=()=>{
    const pct=au.duration?au.currentTime/au.duration*100:0;
    const f=document.getElementById('vf-'+uid);if(f)f.style.width=pct+'%';
    const d=document.getElementById('vd-'+uid);if(d)d.textContent=fmtDur(au.currentTime);
  };
  au.onended=()=>{btn.textContent='‚ñ∂';URL.revokeObjectURL(url);};
  au.play();
}

// ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGlobal(){
  view='global';peerName='';targetUser=null;clearTargetUI();
  clearMsgs();lastDate='';lastSender=null;
  globalCache.forEach(m=>renderMsg(m,true));
  scrollBot();updateHead();hideDmBanner();activateNav(null);
}
function openDM(peerId,pName){
  view=peerId;peerName=pName;targetUser=null;clearTargetUI();
  clearMsgs();lastDate='';lastSender=null;
  clearUnread('dm:'+peerId);updateHead();showDmBanner(pName);
  ensureDmNav(peerId,pName);activateNav(peerId);
  if(dmCache[peerId]){dmCache[peerId].forEach(m=>renderMsg(m,true));scrollBot();}
  else wsSend({type:'dm_history',peer_id:peerId});
}
function ensureDmNav(pid,pname){
  if($('dn-'+pid))return;
  const nav=$('dm-nav'),d=document.createElement('div');
  d.id='dn-'+pid;d.className='nav-item';d.dataset.peer=pid;
  d.innerHTML=`<div style="width:22px;height:22px;border-radius:50%;background:${C(pid)}22;color:${C(pid)};display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;flex-shrink:0">${ini(pname)}</div>
    <span class="lbl">${esc(pname)}</span>`;
  d.addEventListener('click',()=>openDM(pid,pname));nav.appendChild(d);
}
function activateNav(pid){
  document.querySelectorAll('#dm-nav .nav-item').forEach(el=>el.classList.toggle('active',parseInt(el.dataset.peer)===pid));
}
function renderDmModal(){
  const list=$('dm-modal-list');list.innerHTML='';
  if(!allUsers.length){list.innerHTML='<div style="padding:10px;color:var(--sub)">No other users online</div>';return;}
  allUsers.forEach(u=>{
    const d=document.createElement('div');d.className='pick-item';d.style.borderRadius='var(--rsm)';
    d.innerHTML=`<div class="av32" style="background:${C(u.id)}22;color:${C(u.id)}">${ini(u.name)}</div>
      <div><div class="pname">${esc(u.name)}</div><div class="psub">Open DM</div></div>`;
    d.addEventListener('click',()=>{closeModal('dm-modal');openDM(u.id,u.name);});
    list.appendChild(d);
  });
}
$('newdm-btn').addEventListener('click',()=>{renderDmModal();openModal('dm-modal');});
$('dm-back-btn').addEventListener('click',openGlobal);
function updateHead(){
  const av=$('ch-av'),title=$('ch-title'),sub=$('ch-sub');
  if(view==='global'){
    av.style.cssText='background:rgba(74,144,226,.15);color:var(--accent)';
    av.textContent='üí¨';title.textContent='General Chat';sub.textContent=(allUsers.length+1)+' online';
  }else{
    av.style.cssText=`background:${C(view)}22;color:${C(view)}`;
    av.textContent=ini(peerName);title.textContent=peerName;sub.textContent='üîí Private message';
  }
}
function showDmBanner(n){$('dm-banner').classList.add('show');$('dm-banner-text').textContent=`üîí Private chat with ${n}`;}
function hideDmBanner(){$('dm-banner').classList.remove('show');}

// ‚îÄ‚îÄ UNREAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function incUnread(key){
  unread[key]=(unread[key]||0)+1;
  if(key.startsWith('dm:')){
    const pid=parseInt(key.slice(3)),el=$('dn-'+pid);if(!el)return;
    let b=el.querySelector('.badge');
    if(!b){b=document.createElement('span');b.className='badge';el.appendChild(b);}
    b.textContent=unread[key]>99?'99+':unread[key];
  }
}
function clearUnread(key){
  unread[key]=0;
  if(key.startsWith('dm:')){const pid=parseInt(key.slice(3)),el=$('dn-'+pid);if(!el)return;el.querySelector('.badge')?.remove();}
}

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-send').addEventListener('click',sendText);
inp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText();}});
inp.addEventListener('input',function(){
  autoH(this);
  const v=this.value,at=v.lastIndexOf('@');
  if(at!==-1&&(at===v.length-1||!v.slice(at+1).includes(' ')))showPicker(v.slice(at+1).toLowerCase());
  else hidePicker();
  const toId=targetUser?.id||(view!=='global'?view:null);
  wsSend({type:'typing',to_id:toId||undefined});
});
function sendText(){
  const text=inp.value.trim();if(!text||!ws||ws.readyState!==1)return;
  const toId=targetUser?.id??(view!=='global'?view:null);
  wsSend({type:'text',text,to_id:toId||undefined});
  inp.value='';autoH(inp);clearTarget();hidePicker();
}
function showPicker(q){
  const p=$('picker'),list=allUsers.filter(u=>u.name.toLowerCase().includes(q));
  if(!list.length){hidePicker();return;}
  p.innerHTML='';
  list.forEach(u=>{
    const d=document.createElement('div');d.className='pick-item';
    d.innerHTML=`<div class="av32" style="background:${C(u.id)}22;color:${C(u.id)};width:26px;height:26px">${ini(u.name)}</div>
      <div><div class="pname">${esc(u.name)}</div><div class="psub">Target this user</div></div>`;
    d.addEventListener('click',()=>{setTarget(u);inp.value=inp.value.slice(0,inp.value.lastIndexOf('@'));hidePicker();});
    p.appendChild(d);
  });
  p.classList.add('open');
}
function hidePicker(){$('picker').classList.remove('open');}
function setTarget(u){
  targetUser=u;$('trow').classList.add('show');
  $('tpills').innerHTML=`<div class="tpill"><div style="width:16px;height:16px;border-radius:50%;background:${C(u.id)}22;color:${C(u.id)};display:inline-flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:700">${ini(u.name)}</div>${esc(u.name)}<button onclick="clearTarget()">‚úï</button></div>`;
}
function clearTarget(){targetUser=null;clearTargetUI();}
function clearTargetUI(){$('trow').classList.remove('show');$('tpills').innerHTML='';}
$('trow-clear').addEventListener('click',clearTarget);

// ‚îÄ‚îÄ FILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-file').addEventListener('click',()=>$('file-in').click());
$('file-in').addEventListener('change',async function(){
  for(const f of Array.from(this.files))await sendFile(f);this.value='';
});
async function sendFile(file){
  if(!ws||ws.readyState!==1)return;
  if(file.size>MAX_MB*1024*1024){sysMsg('‚ö†Ô∏è File too large (max '+MAX_MB+'MB)');return;}
  const b64=await toB64(file);
  const toId=targetUser?.id??(view!=='global'?view:null);
  wsSend({type:'file',filename:file.name,mime:file.type||'application/octet-stream',data:b64,size:file.size,to_id:toId||undefined});
  clearTarget();
}

// ‚îÄ‚îÄ VOICE MSG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mediaStreamMsg;
const btnV=$('btn-voice');
btnV.addEventListener('mousedown',startRec);
btnV.addEventListener('touchstart',e=>{e.preventDefault();startRec();},{passive:false});
btnV.addEventListener('mouseup',stopRec);
btnV.addEventListener('mouseleave',stopRec);
btnV.addEventListener('touchend',stopRec);
async function startRec(){
  if(recState)return;
  try{
    mediaStreamMsg=await navigator.mediaDevices.getUserMedia({audio:true});
    const opts=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?{mimeType:'audio/webm;codecs=opus'}:MediaRecorder.isTypeSupported('audio/webm')?{mimeType:'audio/webm'}:{};
    recState=new MediaRecorder(mediaStreamMsg,opts);
    const chunks=[];
    recState.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
    recState.onstop=()=>{
      const blob=new Blob(chunks,{type:recState.mimeType||'audio/webm'});
      sendVoiceMsg(blob,recSec);
      clearInterval(recTimer);recSec=0;
      $('rtimer').classList.remove('show');
      btnV.classList.remove('rec');btnV.textContent='üé§';
      mediaStreamMsg.getTracks().forEach(t=>t.stop());mediaStreamMsg=null;recState=null;
    };
    recState.start(100);btnV.classList.add('rec');btnV.textContent='‚èπ';
    $('rtimer').classList.add('show');recSec=0;
    recTimer=setInterval(()=>{recSec++;$('rtime').textContent=fmtDur(recSec);},1000);
  }catch(e){sysMsg('‚ö†Ô∏è Microphone access denied');recState=null;}
}
function stopRec(){if(recState&&recState.state!=='inactive')recState.stop();}
async function sendVoiceMsg(blob,dur){
  const b64=await blobB64(blob);
  const toId=targetUser?.id??(view!=='global'?view:null);
  wsSend({type:'voice',data:b64,duration:dur,to_id:toId||undefined});
  clearTarget();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO CALLS ‚Äî WebRTC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Start outgoing call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCall(peerId, pName){
  if(callState!=='idle'){sysMsg('‚ö†Ô∏è Already in a call');return;}
  callPeerId=peerId; callPName=pName; callState='outgoing';
  try{
    localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
  }catch(e){
    sysMsg('‚ö†Ô∏è Mic access denied: '+e.message);
    callState='idle';return;
  }
  showCallUI('outgoing',peerId,pName);
  createPC(peerId);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  wsSend({type:'call-offer',to_id:peerId,sdp:offer.sdp});
}

// ‚îÄ‚îÄ Incoming call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onCallOffer(msg){
  if(callState!=='idle'){wsSend({type:'call-reject',to_id:msg.from_id});return;}
  pendingOffer=msg; callPeerId=msg.from_id; callPName=msg.from_name;
  callState='incoming';
  showCallUI('incoming',msg.from_id,msg.from_name);
  if(Notification?.permission==='granted')
    new Notification('üìû Incoming call',{body:msg.from_name+' is calling'});
}

async function acceptCall(){
  if(!pendingOffer)return;
  try{
    localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
  }catch(e){
    sysMsg('‚ö†Ô∏è Mic access denied');endCall(false);return;
  }
  const {from_id,sdp}=pendingOffer; pendingOffer=null;
  callState='active';
  createPC(from_id);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  await pc.setRemoteDescription({type:'offer',sdp});
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  wsSend({type:'call-answer',to_id:from_id,sdp:answer.sdp});
  showCallUI('active',callPeerId,callPName);
  startCallTimer();
}

function rejectCall(){
  if(pendingOffer){wsSend({type:'call-reject',to_id:pendingOffer.from_id});pendingOffer=null;}
  endCall(false);
}

// ‚îÄ‚îÄ Signaling handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function onCallAnswer(msg){
  if(callState==='outgoing'&&pc){
    await pc.setRemoteDescription({type:'answer',sdp:msg.sdp});
  }
}
async function onIce(msg){
  if(pc&&msg.candidate){
    try{await pc.addIceCandidate(msg.candidate);}catch(e){}
  }
}
function onCallReject(msg){
  if(callState==='outgoing'){endCall(false);sysMsg(`üìµ ${msg.from_name} rejected your call`);}
}
function onCallEnd(msg){
  if(callState!=='idle'){endCall(false);sysMsg(`üìµ ${msg.from_name} ended the call`);}
}
function onCallError(msg){endCall(false);sysMsg('‚ö†Ô∏è '+msg.text);}

// ‚îÄ‚îÄ RTCPeerConnection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createPC(peerId){
  pc=new RTCPeerConnection(ICE);
  pc.onicecandidate=e=>{if(e.candidate)wsSend({type:'ice-candidate',to_id:peerId,candidate:e.candidate});};
  pc.ontrack=e=>{
    $('remote-audio').srcObject=e.streams[0];
    // Switch UI to active once we get audio
    if(callState==='outgoing'){
      callState='active';
      showCallUI('active',callPeerId,callPName);
      startCallTimer();
    }
  };
  pc.onconnectionstatechange=()=>{
    if(['disconnected','failed','closed'].includes(pc.connectionState))endCall(true);
  };
}

// ‚îÄ‚îÄ End call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function endCall(notify=true){
  if(notify&&callPeerId&&callState!=='idle')wsSend({type:'call-end',to_id:callPeerId});
  if(pc){pc.close();pc=null;}
  if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
  $('remote-audio').srcObject=null;
  stopCallTimer(); pendingOffer=null;
  callState='idle'; callPeerId=null; callPName=''; micMuted=false;
  $('call-screen').classList.remove('show');
}

// ‚îÄ‚îÄ Mute ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMic(){
  micMuted=!micMuted;
  localStream?.getAudioTracks().forEach(t=>t.enabled=!micMuted);
  renderCallBtns();
}

// ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startCallTimer(){
  callSecs=0;
  callInterval=setInterval(()=>{
    callSecs++;
    const m=Math.floor(callSecs/60),s=callSecs%60;
    $('call-timer').textContent=m+':'+String(s).padStart(2,'0');
  },1000);
}
function stopCallTimer(){clearInterval(callInterval);callInterval=null;$('call-timer').textContent='';}

// ‚îÄ‚îÄ Call UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCallUI(state, peerId, pName){
  const screen=$('call-screen');
  screen.classList.add('show');

  const av=$('call-av');
  av.textContent=ini(pName);
  av.style.background=C(peerId)+'33';
  av.style.color=C(peerId);
  $('call-name').textContent=pName;
  $('sound-wave').style.display='none';

  if(state==='incoming'){
    av.className='call-av ringing';
    $('call-status').textContent='Incoming call‚Ä¶';
    $('call-timer').textContent='';
    renderCallBtns('incoming');
  }else if(state==='outgoing'){
    av.className='call-av ringing';
    $('call-status').textContent='Calling‚Ä¶';
    $('call-timer').textContent='';
    renderCallBtns('outgoing');
  }else if(state==='active'){
    av.className='call-av active-pulse';
    $('call-status').textContent='In call';
    $('sound-wave').style.display='flex';
    renderCallBtns('active');
  }
}

function renderCallBtns(state){
  if(!state){
    // re-render current state
    state = callState==='active'?'active':callState==='incoming'?'incoming':'outgoing';
  }
  const btns=$('call-btns'); btns.innerHTML='';

  if(state==='incoming'){
    btns.innerHTML=`
      <button class="cbtn green" onclick="acceptCall()" title="Accept">üìû</button>
      <button class="cbtn red"   onclick="rejectCall()" title="Reject">üìµ</button>`;
  }else if(state==='outgoing'){
    btns.innerHTML=`
      <button class="cbtn red" onclick="endCall(true)" title="Cancel">üìµ</button>`;
  }else{
    // active
    const micIcon=micMuted?'üîá':'üé§';
    const micClass=micMuted?'cbtn grey on':'cbtn grey';
    btns.innerHTML=`
      <button class="${micClass}" onclick="toggleMic()" title="Mute">${micIcon}</button>
      <button class="cbtn red" onclick="endCall(true)" title="End call">üìµ</button>`;
  }
}

// ‚îÄ‚îÄ Leave / utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('leave-btn').addEventListener('click',()=>{
  endCall(true);ws&&ws.close();clearTimeout(reconnTimer);myName='';myId=null;
  $('app').classList.remove('on');$('login').classList.remove('out');
  clearMsgs();globalCache=[];
});

function openModal(id){$(id).classList.add('open');}
function closeModal(id){$(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
function clearMsgs(){msgs.innerHTML='';lastDate='';lastSender=null;}
function scrollBot(){msgs.scrollTop=msgs.scrollHeight;}
function maybeDate(isoStr){
  if(!isoStr)return;const d=isoStr.split('T')[0];if(d===lastDate)return;lastDate=d;
  const el=document.createElement('div');el.className='date-div';el.textContent=fmtDate(isoStr);msgs.appendChild(el);
}
function autoH(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,140)+'px';}
function J(o){return JSON.stringify(o,null,0);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function linkify(s){return s.replace(/(https?:\/\/[^\s<>"]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--accent)">$1</a>');}
function ini(n){return(n||'?').slice(0,2).toUpperCase();}
function C(id){return COLORS[(id||0)%COLORS.length];}
function fmtB(b){if(!b)return'?';if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function fmtDur(s){s=Math.floor(s||0);return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function fmtDate(iso){const d=new Date(iso),t=new Date(),df=Math.floor((t-d)/86400000);if(df===0)return'Today';if(df===1)return'Yesterday';return d.toLocaleDateString('en-US',{day:'numeric',month:'long'});}
function fEmoji(m){if(!m)return'üìÑ';if(m.startsWith('image/'))return'üñºÔ∏è';if(m.startsWith('video/'))return'üé¨';if(m.startsWith('audio/'))return'üéµ';if(m.includes('pdf'))return'üìë';if(m.match(/zip|rar|7z/))return'üóúÔ∏è';return'üìÑ';}
function toB64(f){return new Promise((r,j)=>{const rd=new FileReader();rd.onload=()=>r(rd.result.split(',')[1]);rd.onerror=j;rd.readAsDataURL(f);});}
function blobB64(b){return new Promise((r,j)=>{const rd=new FileReader();rd.onload=()=>r(rd.result.split(',')[1]);rd.onerror=j;rd.readAsDataURL(b);});}
function b64Blob(b64,mime){const bin=atob(b64),arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);return new Blob([arr],{type:mime});}
function dlFile(n,m,d){const a=document.createElement('a');a.href=`data:${m};base64,${d}`;a.download=n;a.click();}
function lightbox(m,d){const w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><body style="margin:0;background:#000;display:flex;justify-content:center;align-items:center;min-height:100vh"><img src="data:${m};base64,${d}" style="max-width:100vw;max-height:100vh;object-fit:contain"></body></html>`);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE UI LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const isMobile = () => window.innerWidth <= 600;

let mobTab = 'chat';          // 'chat' | 'contacts'
let mobDmPeers = {};          // peerId ‚Üí peerName (opened DMs)
let mobTotalUnread = 0;

function mobileTab(tab) {
  if (!isMobile()) return;
  mobTab = tab;
  const chat = document.getElementById('mobile-chat-panel');
  const cont = document.getElementById('mobile-contacts-panel');
  document.getElementById('mnav-chat').classList.toggle('active', tab==='chat');
  document.getElementById('mnav-contacts').classList.toggle('active', tab==='contacts');
  if (tab === 'chat') {
    chat.classList.remove('hidden');
    cont.classList.remove('visible');
  } else {
    chat.classList.add('hidden');
    cont.classList.add('visible');
    renderMobContacts();
  }
}

function mobileBackToGeneral() {
  openGlobal();
  updateMobHead();
}

function startCallCurrent() {
  if (view !== 'global' && typeof view === 'number') {
    startCall(view, peerName);
  }
}

// Patch openGlobal / openDM to update mobile head
const _og = openGlobal;
function openGlobal() {
  _og();
  updateMobHead();
  if (isMobile()) mobileTab('chat');
}

const _odm = openDM;
function openDM(peerId, pName) {
  _odm(peerId, pName);
  mobDmPeers[peerId] = pName;
  updateMobHead();
  renderMobDmList();
  if (isMobile()) mobileTab('chat');
}

function updateMobHead() {
  if (!isMobile()) return;
  const av    = document.getElementById('mob-av');
  const title = document.getElementById('mob-title');
  const sub   = document.getElementById('mob-sub');
  const callB = document.getElementById('mob-call-btn');
  const backB = document.getElementById('mob-back-btn');
  if (view === 'global') {
    av.style.cssText = 'background:rgba(74,144,226,.15);color:var(--accent)';
    av.textContent = 'üí¨';
    title.textContent = 'General Chat';
    sub.textContent = (allUsers.length + 1) + ' online';
    callB.style.display = 'none';
    backB.style.display = 'none';
  } else {
    av.style.cssText = `background:${C(view)}22;color:${C(view)}`;
    av.textContent = ini(peerName);
    title.textContent = peerName;
    sub.textContent = 'üîí Private';
    callB.style.display = 'flex';
    backB.style.display = 'flex';
  }
}

function renderMobContacts() {
  renderMobOnline();
  renderMobDmList();
  const me = document.getElementById('mob-me-label');
  if (me) me.textContent = 'Logged in as ' + (myName || '‚Äî');
}

function renderMobOnline() {
  const el = document.getElementById('mob-online-list');
  if (!el) return;
  el.innerHTML = '';
  if (!allUsers.length) {
    el.innerHTML = '<div style="padding:12px 16px;color:var(--sub);font-size:.83rem">No other users online</div>';
    return;
  }
  allUsers.forEach(u => {
    const d = document.createElement('div');
    d.className = 'mob-user-item';
    d.innerHTML = `
      <div class="mob-av" style="background:${C(u.id)}22;color:${C(u.id)}">${ini(u.name)}</div>
      <div>
        <div class="mob-uname">${esc(u.name)}</div>
        <div class="mob-ustatus">‚óè online</div>
      </div>
      <div class="mob-actions">
        <button class="mob-action-btn chat" title="Message" onclick="event.stopPropagation();openDM(${u.id},'${esc(u.name)}')">üí¨</button>
        <button class="mob-action-btn call" title="Call"    onclick="event.stopPropagation();startCall(${u.id},'${esc(u.name)}')">üìû</button>
      </div>`;
    el.appendChild(d);
  });
}

function renderMobDmList() {
  const el = document.getElementById('mob-dm-list');
  if (!el) return;
  el.innerHTML = '';
  const peers = Object.entries(mobDmPeers);
  if (!peers.length) {
    el.innerHTML = '<div style="padding:10px 16px;color:var(--sub);font-size:.83rem">No conversations yet</div>';
    return;
  }
  peers.forEach(([pid, pname]) => {
    pid = parseInt(pid);
    const d = document.createElement('div');
    d.className = 'mob-dm-item' + (view === pid ? ' act-dm' : '');
    const u = unread['dm:'+pid] || 0;
    d.innerHTML = `
      <div class="mob-av" style="background:${C(pid)}22;color:${C(pid)}">${ini(pname)}</div>
      <div>
        <div class="mob-uname">${esc(pname)}</div>
        <div class="mob-ustatus">tap to open</div>
      </div>
      ${u > 0 ? `<span class="mob-dm-badge">${u > 99 ? '99+' : u}</span>` : ''}`;
    d.addEventListener('click', () => openDM(pid, pname));
    el.appendChild(d);
  });
}

// Patch incUnread to update mobile badge
const _incUnread = incUnread;
function incUnread(key) {
  _incUnread(key);
  updateMobBadge();
  if (key.startsWith('dm:')) {
    const pid = parseInt(key.slice(3));
    if (!mobDmPeers[pid]) {
      const u = allUsers.find(u => u.id === pid);
      if (u) { mobDmPeers[pid] = u.name; renderMobDmList(); }
    }
  }
}
const _clearUnread = clearUnread;
function clearUnread(key) {
  _clearUnread(key);
  updateMobBadge();
}
function updateMobBadge() {
  const total = Object.values(unread).reduce((a,b)=>a+(b||0),0);
  const badge = document.getElementById('mob-badge');
  if (!badge) return;
  if (total > 0) { badge.style.display=''; badge.textContent=total>99?'99+':total; }
  else { badge.style.display='none'; }
}

// Init mobile panels after login
const _origConnect = connect;
function connect() {
  _origConnect();
  // After connect + init, mount chat area into mobile panel
  setTimeout(mountMobileChat, 800);
}

function mountMobileChat() {
  if (!isMobile()) return;
  const mcp = document.getElementById('mobile-chat-panel');
  const head = document.getElementById('mob-chat-head');
  // Move #messages, typing-bar, #ibar into mobile panel
  const msgs  = document.getElementById('messages');
  const tbar  = document.getElementById('typing-bar');
  const ibar  = document.getElementById('ibar');
  if (msgs && !mcp.contains(msgs)) {
    mcp.appendChild(msgs);
    mcp.appendChild(tbar);
    mcp.appendChild(ibar);
  }
  updateMobHead();
}

// Patch onUsers to refresh mobile contacts
const _onUsers = onUsers;
function onUsers(msg) {
  _onUsers(msg);
  if (isMobile()) {
    updateMobHead();
    if (mobTab === 'contacts') renderMobContacts();
  }
}

// Patch onInit to setup mobile
const _onInit = onInit;
function onInit(msg) {
  _onInit(msg);
  if (isMobile()) {
    setTimeout(mountMobileChat, 100);
    document.getElementById('mob-me-label').textContent = 'Logged in as ' + myName;
  }
}

</script>
</body>
</html>